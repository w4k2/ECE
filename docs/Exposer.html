<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Exposer.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>Exposer.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p><strong>Exposer</strong> is the representation learning data structure, based on interpretation of uncorrect histogram and scatter-plot.</p>
<h3>Usage</h3>
<p>To create an <em>exposer</em>, all you need is to load a dataset, prepare dictionary with demanded configuration and use them to initiate object.</p>
<pre><code>dataset = Dataset('data/iris.csv','iris')
configuration = {
    'radius': .5, 
    'grain': 15,
    'exposerParticipation': ExposerParticipation.lone,
    'chosenLambda': [2, 3]
}
exposer = Exposer(dataset, configuration)
</code></pre>
<p>For a process of classification, first is it required to clear supports for all samples in dataset. Later you can use <em>exposer</em> to create predictions. Dictionary with scores is provided by a function <code>score()</code> being a member of <code>dataset</code> object.</p>
<pre><code>dataset.clearSupports()
exposer.predict()
scores = dataset.score()
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Dataset</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">png</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">colorsys</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h3><em>Exposer</em> participation</h3>
<p><em>Exposers</em> are dedicated to work in classifier ensembles. To establish possible participations in voting, there is an enum with three possible setups:</p>
<ul>
<li><code>lone</code> - each <em>exposer</em> will have the same influence on voting,</li>
<li><code>theta1</code> - we use single measure for every <em>exposer</em> influence,</li>
<li><code>theta2</code> - there is a measure for every class support coming from each <em>exposer</em>.</li>
</ul>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">ExposerParticipation</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
	<span class="n">lone</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="n">theta1</span> <span class="o">=</span> <span class="mi">2</span>
	<span class="n">theta2</span> <span class="o">=</span> <span class="mi">3</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <h3><span id="_exposer_" href="_exposer_"> <em>Exposer</em> </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Exposer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h4><span id="preparing-an-_exposer_" href="preparing-an-_exposer_"> Preparing an <em>exposer</em> </span></h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>First, we're collecting four values from passed configuration:</p>
<ul>
<li><strong>exposer participation</strong>, described above,</li>
<li><strong>grain</strong>, used as a number of quants of structure in every dimension,</li>
<li><strong>radius</strong>, used as percentage range of influence generated by every data sample,</li>
<li><strong>chosen lambda</strong>, a set of features describing the subspace.</li>
</ul>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="bp">self</span><span class="o">.</span><span class="n">exposerParticipation</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;exposerParticipation&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grain</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;grain&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chosenLambda</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;chosenLambda&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Later, we're gathering the dataset and calculating number of data structure dimensions, from a number of features of <code>chosenLambda</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chosenLambda</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>It gives us enough information to create an empty <code>matrix</code> which will store all the information in our <em>exposer</em>. Abstraction of n-dimensional array of <em>pixels</em> is realized by the one dimensional list, combined with <code>position()</code> function, which will be described later. Pixel here consists of as many values, as we have classes in dataset.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">))</span>
		<span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">)]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hsv</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>To optimize time of positioning in array, we once calculate a vector of consecutive powers of given <code>grain</code>. </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>To optimize time of computing a single sample influence, we prepare the set of base move-vectors for given <code>radius</code>, with precalculated distance to a central point.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">dropVectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropVectors</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <h4><span id="exposing-array-on-a-beam-of-samples" href="exposing-array-on-a-beam-of-samples"> Exposing array on a beam of samples </span></h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">samples</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>For every <code>sample</code> in a <code>dataset</code>, we read its <code>label</code> and a subset of its <code>features</code> for <code>chosenLambda</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">label</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">label</span>
			<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chosenLambda</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>According to <code>features</code>, we <code>establish</code> a <code>location</code> of point in exposers space, corresponding to processed <code>sample</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">location_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span>			
			<span class="n">location_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">location_f</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>The euclidean distance between quantified (<code>location_i</code>) and exact location (<code>location_f</code>) lets us to establish a <code>factor</code> used to correct distances comming from base vectors. </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span><span class="n">location_i</span><span class="p">,</span><span class="n">location_f</span><span class="p">)]))</span>
			<span class="n">factor</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">-</span> <span class="n">distance</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Now we can iterate every <code>dropVector</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">for</span> <span class="n">dropVector</span> <span class="ow">in</span> <span class="n">dropVectors</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Simple addition between quantified location and a drop vector gives us a real location (<code>vector</code>), where the influence will be placed. </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">vector</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">dropVector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">location_i</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Thus the real location may overflow the space of <em>exposer</em>, we need to deal with it by checking if its value fits in range of matrix.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">overflow</span> <span class="o">=</span> <span class="bp">False</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">:</span>
						<span class="n">overflow</span> <span class="o">=</span> <span class="bp">True</span>
						<span class="k">continue</span>
				<span class="k">if</span> <span class="n">overflow</span><span class="p">:</span>
					<span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Finally, we can calculate the real <code>influence</code> as a product of drop vector distance from central point and precalculated factor. After calculating its index for single-dimension representation, it is added to matrix at row corresponding to a sample <code>label</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">influence</span> <span class="o">=</span> <span class="n">dropVector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span>
				<span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">position</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">influence</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <h4><span id="matrix-normalization" href="matrix-normalization"> Matrix normalization </span></h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>We normalize values of each class in range (0,1).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">foo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">/=</span> <span class="n">foo</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <h4><span id="calculating-measures" href="calculating-measures"> Calculating measures </span></h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">treshold</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">thetas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>
		<span class="n">thetas_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>

		<span class="n">presence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>

		<span class="n">treshold_v</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>To establish measures, we calculate HSV representation of color for every sample. Like in classic RGB2HSV computation, V is a maximum value from cone-response vector and S is a product of dividing delta by V. To receive a delta for situations, where we have different number of base colors than three, we are simply dividing index of maximal value by a number of classes.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">pixel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">):</span>
			<span class="n">cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span>
			<span class="n">cmax_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span>
			<span class="n">cmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span>
			<span class="n">cmin_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">cmax</span> <span class="o">-</span> <span class="n">cmin</span>

			<span class="n">hue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cmax_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>
			<span class="n">saturation</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">if</span> <span class="n">cmax</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">saturation</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">cmax</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">cmax</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">hsv</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">saturation</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>A measure for a single class is an average saturation of decidive vectors with value higher than given treshold.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">treshold</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">thetas</span><span class="p">[</span><span class="n">cmax_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">saturation</span>
				<span class="n">thetas_count</span><span class="p">[</span><span class="n">cmax_i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>New approach</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">treshold_v</span><span class="p">:</span>
				<span class="n">presence</span><span class="p">[</span><span class="n">cmax_i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

		<span class="n">presence</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">presence</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span> <span class="o">-</span> <span class="n">presence</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>And a single measure per <em>exposer</em> is mean value of class measures.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="bp">self</span><span class="o">.</span><span class="n">thetas</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">div</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thetas</span><span class="p">,</span> <span class="n">thetas_count</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thetas</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">thetas</span> <span class="o">=</span> <span class="n">t</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <h3><span id="prediction" href="prediction"> Prediction </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">test</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>To predict a class for a <code>sample</code> from a test set, we read a subset of its features for chosen lambda and calculate a corresponding location for existing <em>exposer</em>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chosenLambda</span><span class="p">]</span>
			<span class="n">location</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Thus the testing set could contain samples with feature values outside the range from a training set, we need to deal with a hazard of matrix overflow.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">location</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">:</span>
					<span class="n">location</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span> <span class="o">-</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Corrected location makes possible to calculate <code>position</code> of testing sample in single-dimension representation, which lets us to gather the corresponding <code>support</code> vector.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
			<span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">position</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>For the <strong>lone</strong> participation, we simply add the support vector to the support accumulator inside the sample object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposerParticipation</span> <span class="o">==</span> <span class="n">ExposerParticipation</span><span class="o">.</span><span class="n">lone</span><span class="p">:</span>
				<span class="n">sample</span><span class="o">.</span><span class="n">support</span> <span class="o">+=</span> <span class="n">support</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>If it is a <strong>theta1</strong> participation, we increase support accumulator by a product of ensemble support and a scalar measure <code>theta</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposerParticipation</span> <span class="o">==</span> <span class="n">ExposerParticipation</span><span class="o">.</span><span class="n">theta1</span><span class="p">:</span>
				<span class="n">sample</span><span class="o">.</span><span class="n">support</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">support</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>When we use <strong>theta2</strong>, a product multiplies ensemble support and a vector measure <code>thetas</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposerParticipation</span> <span class="o">==</span> <span class="n">ExposerParticipation</span><span class="o">.</span><span class="n">theta2</span><span class="p">:</span>
				<span class="n">sample</span><span class="o">.</span><span class="n">support</span> <span class="o">+=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thetas</span><span class="p">,</span> <span class="n">support</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Finally, we demand on <code>sample</code> to establish a prediction, according to its accumulated support vector.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">sample</span><span class="o">.</span><span class="n">decidePrediction</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <hr />
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <h3><span id="helpers" href="helpers"> Helpers </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <h4><span id="position-calculator" href="position-calculator"> Position calculator </span></h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Position in <code>R^n</code> to <code>R</code> transformation is calculated using equation <code>i(p) = c E(n-1)(k=0 p_k * n^k</code>,</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
			<span class="n">acc</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">acc</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <h4><span id="drop-vectors-optimization" href="drop-vectors-optimization"> Drop vectors optimization </span></h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">def</span> <span class="nf">dropVectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>As it was said before, to optimize time of calculating single sample influence, we prepare a set of base move-vectors located in given radius around centre point.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">base_vectors</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">centre</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>We need to calculate quantified radius according to percentage radius in given number of quants. It makes possible to calculate a diameter and a beginning (in abstraction, a top left) drop vector position.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">radius_q</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">)</span>
		<span class="n">diameter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius_q</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="n">beginning</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span> <span class="n">radius_q</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>We use two helping vectors (<code>v</code> and <code>z</code>) to calculate relative position of point.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
		<span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
			<span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">diameter</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>And iterate all points in range.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">pow</span><span class="p">(</span><span class="n">diameter</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)):</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">diameter</span><span class="p">:</span>
					<span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">point</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">beginning</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>For every point we calculate euclidian distance between it and a centre point.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span><span class="n">centre</span><span class="p">,</span><span class="n">point</span><span class="p">)]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>If the distance is lower than quantified radius, we extend the base vector list with a tuple of location and influence, computed as dequantified difference between the two compared values.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">radius_q</span><span class="p">:</span>
				<span class="n">base_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">point</span><span class="p">),</span> <span class="p">(</span><span class="n">radius_q</span> <span class="o">-</span> <span class="n">distance</span><span class="p">)</span> <span class="o">/</span> <span class="n">radius_q</span><span class="p">))</span>

		<span class="k">return</span> <span class="n">base_vectors</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <h4>Visualization</h4>
<p>The visualization of the complete <em>exposer</em>, as long as we will have only a two-dimensional screens at our computers, will be a flat PNG image. </p>
<p>RGB values comes here from first three classes of dataset (if we have a binary problem, only red and green channel will be populated), combined with a HSV2RGB conversion, while the axis describes first two dimensions of <em>exposer</em> matrix. </p>
<p>Below we can see an example visualization for the <code>iris</code> dataset with chosen lambda of <code>[2, 3]</code> for <code>1.0</code> radius and grain of <code>256</code> quants.</p>
<p><img alt="" src="exposer_vis.png" /></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">def</span> <span class="nf">png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">240</span><span class="p">):</span>
		<span class="n">image</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">):</span>
			<span class="n">row</span> <span class="o">=</span> <span class="p">()</span>
			<span class="n">vector</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
			<span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
			<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">):</span>
				<span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
				<span class="n">hsv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">vector</span><span class="p">)]</span>
				<span class="n">support</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">vector</span><span class="p">)])</span>
				<span class="n">rgb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
				<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">support</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="k">break</span>
					<span class="n">rgb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

				<span class="n">h</span> <span class="o">=</span> <span class="n">hsv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">hsv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">hsv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

				<span class="n">c</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">c</span>
				<span class="n">x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="mf">6.</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

				<span class="k">if</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">:</span>
					<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span>
				<span class="k">elif</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mf">2.</span><span class="o">/</span><span class="mi">6</span><span class="p">:</span>
					<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span>
				<span class="k">elif</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mf">3.</span><span class="o">/</span><span class="mi">6</span><span class="p">:</span>
					<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span>
				<span class="k">elif</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mf">4.</span><span class="o">/</span><span class="mi">6</span><span class="p">:</span>
					<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span>
				<span class="k">elif</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">:</span>
					<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span>

				<span class="n">row</span> <span class="o">+=</span> <span class="p">(</span>\
					<span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">scale</span><span class="p">),</span> \
					<span class="n">rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">scale</span><span class="p">),</span> \
					<span class="n">rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">scale</span><span class="p">))</span>
			<span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span>
		
		<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grain</span><span class="p">)</span>
		<span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span> <span class="p">;</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
